operator_image: DOES_NOT_EXIST # Parameter value provided by mage (defaults to image for current HEAD)
dse_image: datastaxlabs/dse-k8s-server:6.8.0-20191113
yaml_src_branch: master
---
# happy path test to stand up a few pods and make sure we can communicate with them
ensemble:
    server:
        node.count: 1
        provisioner:
            name: gke
            properties:
                project: eng-gce-te-devtools
                region: us-central1
                machine.type: n1-standard-1
                create.extra_args: |
                        --no-enable-basic-auth \
                        --cluster-version "1.15" \
                        --image-type "COS" \
                        --disk-type "pd-ssd" \
                        --disk-size "50" \
                        --metadata disable-legacy-endpoints=true \
                        --scopes "https://www.googleapis.com/auth/cloud-platform" \
                        --enable-stackdriver-kubernetes \
                        --enable-ip-alias \
                        --default-max-pods-per-node "110" \
                        --addons HorizontalPodAutoscaling,HttpLoadBalancing \
                        --enable-autoupgrade \
                        --enable-autorepair \
                        --network "projects/eng-gce-te-devtools/global/networks/container-tooling-testing" \
                        --subnetwork "projects/eng-gce-te-devtools/regions/us-central1/subnetworks/container-tooling-testing"
        configuration_manager:
            - name: local_files
              properties:
                files:
                  - git:
                      repo: git@github.com:riptano/dse-operator.git # makes all files in the dse-operator repo available to CMs/Modules which support managed files (i.e. the k8s stuff)
                      branch: {{yaml_src_branch}} # all files will be from this branch, specified as a param to the fallout test yaml
            - name: dse_operator
              properties:
                  namespace: "optest"

                  operator.manifest: <<file:dse-operator/fallout/tests/gkeDseOperatorGetPods/operator_manifest.yaml>>
                  operator.template_params:
                    operator_image: {{operator_image}}

                  dse_cluster.manifest: <<file:dse-operator/fallout/tests/gkeDseOperatorGetPods/dse_cluster_manifest.yaml>>
                  dse_cluster.template_params:
                    dse_image: {{dse_image}}
    client: server

workload:
  phases:
    - show-pods:
        module: kubectl
        properties:
          command: get pods
          iterations: 5
          lifetime: once
